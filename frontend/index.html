<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VINFREAK — Porsche Listings</title>
  <meta name="description" content="Browse Porsche listings with full details and filters." />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">VINFREAK — Porsche Listings</h1>
      <p class="text-sm text-gray-600 mt-1">All details. All filters. Data from <code>cars.db</code>.</p>
    </header>

    <form id="filterForm" class="grid md:grid-cols-8 gap-3 bg-white p-4 rounded-2xl shadow">
      <input name="search" placeholder="Search (make/model/city/state/trim)" class="border rounded-lg px-3 py-2 md:col-span-2" />
      <input name="make" placeholder="Make" value="Porsche" class="border rounded-lg px-3 py-2" />
      <input name="model" placeholder="Model" class="border rounded-lg px-3 py-2" />
      <input name="trim" placeholder="Trim" class="border rounded-lg px-3 py-2" />
      <input name="city" placeholder="City" class="border rounded-lg px-3 py-2" />
      <input name="state" placeholder="State (e.g., CA)" class="border rounded-lg px-3 py-2" />
      <input name="engine" placeholder="Engine contains…" class="border rounded-lg px-3 py-2" />
      <select name="auction_status" class="border rounded-lg px-3 py-2">
        <option value="">Auction status</option>
        <option>Clean</option>
        <option>Salvage</option>
      </select>

      <select name="transmission" class="border rounded-lg px-3 py-2">
        <option value="">Transmission</option>
        <option value="manual">Manual</option>
        <option value="automatic">Automatic</option>
      </select>
      <select name="drivetrain" class="border rounded-lg px-3 py-2">
        <option value="">Drivetrain</option>
        <option value="FWD">FWD</option>
        <option value="RWD">RWD</option>
        <option value="AWD">AWD</option>
        <option value="4WD">4WD</option>
      </select>
      <input name="body_type" placeholder="Body type (e.g., coupe)" class="border rounded-lg px-3 py-2" />
      <input name="seller_type" placeholder="Seller type" class="border rounded-lg px-3 py-2" />
      <input name="exterior_color" placeholder="Exterior color" class="border rounded-lg px-3 py-2" />
      <input name="interior_color" placeholder="Interior color" class="border rounded-lg px-3 py-2" />

      <input name="year_from" type="number" min="1900" placeholder="Year from" class="border rounded-lg px-3 py-2" />
      <input name="year_to" type="number" min="1900" placeholder="Year to" class="border rounded-lg px-3 py-2" />
      <input name="mileage_min" type="number" min="0" placeholder="Min mileage" class="border rounded-lg px-3 py-2" />
      <input name="mileage_max" type="number" min="0" placeholder="Max mileage" class="border rounded-lg px-3 py-2" />
      <input name="price_min" type="number" step="0.01" placeholder="Min $" class="border rounded-lg px-3 py-2" />
      <input name="price_max" type="number" step="0.01" placeholder="Max $" class="border rounded-lg px-3 py-2" />

      <select name="sort" class="border rounded-lg px-3 py-2">
        <option value="">Sort</option>
        <option value="price_asc">Price ↑</option>
        <option value="price_desc">Price ↓</option>
        <option value="year_desc">Year ↓</option>
        <option value="year_asc">Year ↑</option>
        <option value="mileage_asc">Mileage ↑</option>
        <option value="mileage_desc">Mileage ↓</option>
      </select>

      <div class="md:col-span-8 flex gap-2">
        <button class="bg-black text-white rounded-xl px-4 py-2 hover:opacity-90">Apply Filters</button>
        <button id="clearBtn" type="button" class="bg-white text-gray-700 border rounded-xl px-4 py-2 hover:bg-gray-50">Clear</button>
      </div>
    </form>

    <div id="stats" class="mt-4 text-sm text-gray-600">Loading…</div>

    <div id="list" class="mt-3 grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>

    <nav class="flex items-center gap-2 mt-6">
      <button id="prevBtn" class="px-3 py-2 bg-white border rounded-xl disabled:opacity-40">Prev</button>
      <span id="pageInfo" class="text-sm"></span>
      <button id="nextBtn" class="px-3 py-2 bg-white border rounded-xl disabled:opacity-40">Next</button>
    </nav>
  </div>

  <script>
    const API = 'http://127.0.0.1:8000';
    let page = 1;
    let pageSize = 12;
    let total = 0;

    function stripEmpty(params) {
      for (const [k, v] of Array.from(params.entries())) {
        if (v === null || v === undefined || String(v).trim() === '') {
          params.delete(k);
        }
      }
      return params;
    }

    function money(n) { return n == null ? '' : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n); }

    function itemCard(c) {
      return `
        <a href="car.html?id=${encodeURIComponent(c.id)}" class="bg-white rounded-2xl shadow overflow-hidden flex flex-col hover:ring-2 ring-black/10 transition">
          <img src="${c.image_url || 'https://picsum.photos/seed/car/800/480'}" class="w-full h-48 object-cover" alt="${c.make || 'Car'} image" loading="lazy"/>
          <div class="p-4 flex-1 flex flex-col">
            <div class="flex justify-between items-baseline gap-3">
              <h3 class="text-lg font-semibold">${c.year || ''} ${c.make || ''} ${c.model || ''}${c.trim ? (' · ' + c.trim) : ''}</h3>
              <div class="text-xl font-bold whitespace-nowrap">${money(c.price)}</div>
            </div>
            <p class="text-sm text-gray-600 mt-1">${[c.city, c.state].filter(Boolean).join(', ')}</p>
            <p class="text-sm text-gray-600">${c.mileage != null ? (Number(c.mileage).toLocaleString()+' mi') : ''} · ${c.transmission || ''} · ${c.fuel_type || ''}</p>
          </div>
        </a>`;
    }

    async function fetchCars() {
      const form = document.getElementById('filterForm');
      const params = new URLSearchParams(new FormData(form));
      params.set('page', page);
      params.set('page_size', pageSize);
      stripEmpty(params);

      const res = await fetch(`${API}/cars?${params.toString()}`);
      if (!res.ok) {
        const err = await res.text();
        document.getElementById('list').innerHTML =
          `<div class="text-red-600 bg-red-50 border border-red-200 rounded-xl p-3">Error ${res.status}: ${err}</div>`;
        document.getElementById('stats').textContent = 'Error loading results.';
        return;
      }
      const data = await res.json();
      total = data.total || 0;
      document.getElementById('list').innerHTML = (data.items || []).map(itemCard).join('');
      const pages = Math.max(1, Math.ceil(total / pageSize));
      document.getElementById('stats').textContent = `${total} results · page ${page} of ${pages}`;
      document.getElementById('pageInfo').textContent = `Page ${page}`;
      document.getElementById('prevBtn').disabled = page <= 1;
      document.getElementById('nextBtn').disabled = page >= pages;
    }

    document.getElementById('filterForm').addEventListener('submit', (e) => { e.preventDefault(); page = 1; fetchCars(); });
    document.getElementById('clearBtn').addEventListener('click', () => { document.getElementById('filterForm').reset(); page = 1; fetchCars(); });
    document.getElementById('prevBtn').addEventListener('click', () => { page = Math.max(1, page - 1); fetchCars(); });
    document.getElementById('nextBtn').addEventListener('click', () => { page = page + 1; fetchCars(); });

    fetchCars();
  </script>
</body>
</html>
